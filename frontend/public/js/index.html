<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>积木模块</title>
    <script src="blockly_compressed.js"></script>
    <script src="blocks_compressed.js"></script>
    <script src="javascript_compressed.js"></script>
    <script src="python_compressed.js"></script>
    <script src="dart_compressed.js"></script>
    <script type="text/javascript" src="acorn_interpreter.js"></script>
    <script src="zh.js"></script>
    <script type="text/javascript" src="prettifybundle.js"></script>
    <script src="code.js"></script>
    <script src="FileSaver.min.js"></script>
    <script src="jquery.min.js"></script>
    <script src="prettify.js"></script>
    <script src="storage.js"></script>
    <script src="typescript.js"></script>
    <script src="ts2c.bundle.js"></script>
    <link rel="stylesheet" type="text/css" href="devsite-cyan.css">
    <style>
        body {
            background-color: #fff;
            font-family: sans-serif;
        }

        h1 {
            font-weight: normal;
            font-size: 140%;
        }
    </style>
    <style type="text/css">
        .app-container {
            position: absolute;
            top: 35px;
            bottom: 0;
            left: 0;
            right: 0;
            overflow: visible;
            background-color: #0097a7;
            box-shadow: 0 0 4px rgba(0, 0, 0, .14), 0 4px 8px rgba(0, 0, 0, .28);
            margin: 10px;
        }

        .main {
            position: absolute;
            top: 8px;
            bottom: 8px;
        }

        .blockly-panel {
            left: 8px;
            right: 298px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, .37);
        }

        .output-panel {
            right: 8px;
            width: 282px;
            background-color: white;
            overflow: scroll;
            padding: 8px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, .37);
        }

        .dropdown-bar {
            display: block;
            font-family: sans-serif;
            font-size: 16px;
            width: 200px;
            margin-left: auto;
            margin-right: auto;
        }

        #languageDropdown {
            border: 0;
            background-color: transparent;
            font-size: 16px;
            outline: none;
        }

        #im-just-an-underline {
            border-bottom: 1px solid;
            display: inline;
            padding-right: 5px;
        }

        .POps {
            height: 1px;
            border: 0;
            background-color: rgba(0, 0, 0, .2);
        }

        .play-button {
            position: absolute;
            bottom: 24px;
            right: 24px;
            border-radius: 100%;
            color: white;
            width: 56px;
            height: 56px;
            line-height: 56px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, .37);
            -webkit-transition: box-shadow .3s ease-in-out;
            text-align: center;
            font-weight: 500;
            background-color: #0097A7;
            /*cursor: pointer;*/

            cursor: crosshair;
        }

        .play-button:hover {
            box-shadow: 0 2px 2px rgba(0, 0, 0, .2), 0 6px 10px rgba(0, 0, 0, .3);
            transition: box-shadow .3s ease-in-out;
        }

        .but-not-that-pretty {
            border: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
        }
    </style>
</head>

<body>
    <div style="text-align:center;margin:0 auto;height: 15px;">

        <button id="trashButton" class="text primary" title="重置编程区">重置</button>
        <button id="runButton" class="text" title="运行程序">机器人运行</button>
        <button id="stopButton" class="text" title="停止运行">停止</button>
        <!-- <button id="robotInfoButton" class="text" title="机器人信息">设置</button> -->
        <!-- <a id="inputView" href="javascript:;" class="file">导入本地文件
            <input type="file" name="" id="" onchange="Code.importXmlFile(this)">
        </a> -->
        <button id="saveButton" class="text" title="保存程序">导出</button>
        <!-- <button id="uploadButton" class="text" title="上传程序">云保存</button> -->
    </div>
    <div class="app-container">
        <div id="blocklyDiv" class="main blockly-panel"></div>
        <div id="codeDiv" class="main output-panel">
            <div class="dropdown-bar">
                编程语言:
                <div id="im-just-an-underline">
                    <select id="languageDropdown" onChange="myUpdateFunction();">
                        <option value="Dart">C</option>
                        <!-- <option value="Python">Python</option> -->
                        <!-- <option value="PHP">PHP</option> -->
                        <!-- <option value="Lua">Lua</option> -->
                        <option value="JavaScript">JavaScript</option>
                    </select>
                </div>
            </div>
            <hr class="POps">
            <pre></pre>
        </div>
        <div id="playButton" class="play-button material-icons">运行</div>
    </div>
    <!-- 显示模块 -->
    <xml id="toolbox" style="display: none">
        <category id="catLogic" colour="210" name="逻辑&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;">
            <block type="controls_if"></block>
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
            <block type="logic_negate"></block>
            <block type="logic_boolean"></block>
            <block type="logic_null"></block>
            <block type="logic_ternary"></block>
        </category>
        <category id="catLoops" colour="120" name="循环">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="controls_whileUntil"></block>
            <block type="controls_for">
                <value name="FROM">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="TO">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
                <value name="BY">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
            <block type="controls_forEach"></block>
            <block type="controls_flow_statements"></block>
        </category>
        <category id="catMath" colour="230" name="数学">
            <block type="math_number"></block>
            <block type="math_arithmetic">
                <value name="A">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="B">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
            <block type="math_single">
                <value name="NUM">
                    <shadow type="math_number">
                        <field name="NUM">9</field>
                    </shadow>
                </value>
            </block>
            <block type="math_trig">
                <value name="NUM">
                    <shadow type="math_number">
                        <field name="NUM">45</field>
                    </shadow>
                </value>
            </block>
            <block type="math_constant"></block>
            <block type="math_number_property">
                <value name="NUMBER_TO_CHECK">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
            </block>
            <block type="math_change">
                <value name="DELTA">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
            <block type="math_round">
                <value name="NUM">
                    <shadow type="math_number">
                        <field name="NUM">3.1</field>
                    </shadow>
                </value>
            </block>
            <block type="math_on_list"></block>
            <block type="math_modulo">
                <value name="DIVIDEND">
                    <shadow type="math_number">
                        <field name="NUM">64</field>
                    </shadow>
                </value>
                <value name="DIVISOR">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="math_constrain">
                <value name="VALUE">
                    <shadow type="math_number">
                        <field name="NUM">50</field>
                    </shadow>
                </value>
                <value name="LOW">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="HIGH">
                    <shadow type="math_number">
                        <field name="NUM">100</field>
                    </shadow>
                </value>
            </block>
            <block type="math_random_int">
                <value name="FROM">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="TO">
                    <shadow type="math_number">
                        <field name="NUM">100</field>
                    </shadow>
                </value>
            </block>
            <block type="math_random_float"></block>
        </category>
        <category id="catText" colour="160" name="文字">
            <block type="text"></block>
            <block type="text_join"></block>
            <block type="text_append">
                <value name="TEXT">
                    <shadow type="text"></shadow>
                </value>
            </block>
            <block type="text_length">
                <value name="VALUE">
                    <shadow type="text">
                        <field name="TEXT">abc</field>
                    </shadow>
                </value>
            </block>
            <block type="text_isEmpty">
                <value name="VALUE">
                    <shadow type="text">
                        <field name="TEXT"></field>
                    </shadow>
                </value>
            </block>
            <block type="text_indexOf">
                <value name="VALUE">
                    <block type="variables_get">
                        <field name="VAR">text</field>
                    </block>
                </value>
                <value name="FIND">
                    <shadow type="text">
                        <field name="TEXT">abc</field>
                    </shadow>
                </value>
            </block>
            <block type="text_charAt">
                <value name="VALUE">
                    <block type="variables_get">
                        <field name="VAR">text</field>
                    </block>
                </value>
            </block>
            <block type="text_getSubstring">
                <value name="STRING">
                    <block type="variables_get">
                        <field name="VAR">text</field>
                    </block>
                </value>
            </block>
            <block type="text_changeCase">
                <value name="TEXT">
                    <shadow type="text">
                        <field name="TEXT">abc</field>
                    </shadow>
                </value>
            </block>
            <block type="text_trim">
                <value name="TEXT">
                    <shadow type="text">
                        <field name="TEXT">abc</field>
                    </shadow>
                </value>
            </block>
            <block type="text_print">
                <value name="TEXT">
                    <shadow type="text">
                        <field name="TEXT">abc</field>
                    </shadow>
                </value>
            </block>
            <block type="text_prompt_ext">
                <value name="TEXT">
                    <shadow type="text">
                        <field name="TEXT">abc</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category id="catLists" colour="260" name="列表">
            <block type="lists_create_with">
                <mutation items="0"></mutation>
            </block>
            <block type="lists_create_with"></block>
            <block type="lists_repeat">
                <value name="NUM">
                    <shadow type="math_number">
                        <field name="NUM">5</field>
                    </shadow>
                </value>
            </block>
            <block type="lists_length"></block>
            <block type="lists_isEmpty"></block>
            <block type="lists_indexOf">
                <value name="VALUE">
                    <block type="variables_get">
                        <field name="VAR">list</field>
                    </block>
                </value>
            </block>
            <block type="lists_getIndex">
                <value name="VALUE">
                    <block type="variables_get">
                        <field name="VAR">list</field>
                    </block>
                </value>
            </block>
            <block type="lists_setIndex">
                <value name="LIST">
                    <block type="variables_get">
                        <field name="VAR">list</field>
                    </block>
                </value>
            </block>
            <block type="lists_getSublist">
                <value name="LIST">
                    <block type="variables_get">
                        <field name="VAR">list</field>
                    </block>
                </value>
            </block>
            <block type="lists_split">
                <value name="DELIM">
                    <shadow type="text">
                        <field name="TEXT">,</field>
                    </shadow>
                </value>
            </block>
            <block type="lists_sort"></block>
        </category>
        <category id="catColour" colour="20" name="颜色">
            <block type="colour_picker"></block>
            <block type="colour_random"></block>
            <block type="colour_rgb">
                <value name="RED">
                    <shadow type="math_number">
                        <field name="NUM">100</field>
                    </shadow>
                </value>
                <value name="GREEN">
                    <shadow type="math_number">
                        <field name="NUM">50</field>
                    </shadow>
                </value>
                <value name="BLUE">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
            </block>
            <block type="colour_blend">
                <value name="COLOUR1">
                    <shadow type="colour_picker">
                        <field name="COLOUR">#ff0000</field>
                    </shadow>
                </value>
                <value name="COLOUR2">
                    <shadow type="colour_picker">
                        <field name="COLOUR">#3333ff</field>
                    </shadow>
                </value>
                <value name="RATIO">
                    <shadow type="math_number">
                        <field name="NUM">0.5</field>
                    </shadow>
                </value>
            </block>
        </category>
        <sep></sep>
        <category id="catVariables" colour="330" custom="VARIABLE" name="变量"></category>
        <category id="catFunctions" colour="290" custom="PROCEDURE" name="函数"></category>
        <sep></sep>
        <category name="运动" colour="160">
            <block type="move_forward"></block>
            <block type="move_back"></block>
            <block type="turn_left"></block>
            <block type="turn_right"></block>
            <block type="move_stop"></block>
            <block type="servo_run"></block>
            <block type="inf_emission"></block>
            <block type="run_code"></block>
            <block type="start_super"></block>
            <block type="stop_super"></block>
        </category>
        <category name="灯光" colour="230">
            <block type="light_color_change"></block>
        </category>
        <category name="语音" colour="65">
            <!--<block type="play_sounds"></block>-->
            <block type="speak"></block>
            <block type="beeper"></block>
            <block type="poem"></block>
        </category>
        <category name="传感器" colour="105">
            <block type="sensor_light"></block>
            <block type="sensor_distance"></block>
            <block type="sensor_mic"></block>
            <block type="sensor_irm"></block>
            <block type="sensor_tra1"></block>
            <block type="sensor_tra2"></block>
            <block type="sensor_tra3"></block>
            <block type="sensor_tra4"></block>
            <block type="sensor_tra5"></block>
            <block type="sensor_tra6"></block>
            <block type="sensor_tra7"></block>
            <block type="sensor_tra8"></block>
            <block type="Get_Ps2Value"></block>
        </category>
        <category name="控制" colour="330">
            <block type="control_delay"></block>
            <block type="control_loops_times"></block>
            <block type="control_loops_forever"></block>
            <block type="Set_CScript_Mode"></block>
        </category>
        <category name="变量" colour="105">
            <block type="variable_set"></block>
            <block type="variable_plus"></block>
            <!--<block type="wait"></block>-->
        </category>
        <sep></sep>
        <category name="机械手" colour="255">
            <block type="servo_open"></block>
            <block type="servo_close"></block>
        </category>
    </xml>
    <!-- 默认模块 -->
    <xml id="blocklyDefault" style="display: none">
        <block type="variables_set">
            <field name="VAR">Count</field>
            <value name="VALUE">
                <block type="math_number">
                    <field name="NUM">1</field>
                </block>
            </value>
            <next>
                <block type="controls_whileUntil" x="16" y="16">
                    <field name="MODE">WHILE</field>
                    <value name="BOOL">
                        <block type="logic_compare">
                            <field name="OP">LTE</field>
                            <value name="A">
                                <block type="variables_get">
                                    <field name="VAR">Count</field>
                                </block>
                            </value>
                            <value name="B">
                                <block type="math_number">
                                    <field name="NUM">3</field>
                                </block>
                            </value>
                        </block>
                    </value>
                    <statement name="DO">
                        <block type="text_print">
                            <value name="TEXT">
                                <block type="text">
                                    <field name="TEXT">Hello World!</field>
                                </block>
                            </value>
                            <next>
                                <block type="variables_set">
                                    <field name="VAR">Count</field>
                                    <value name="VALUE">
                                        <block type="math_arithmetic">
                                            <field name="OP">ADD</field>
                                            <value name="A">
                                                <block type="variables_get">
                                                    <field name="VAR">Count</field>
                                                </block>
                                            </value>
                                            <value name="B">
                                                <block type="math_number">
                                                    <field name="NUM">1</field>
                                                </block>
                                            </value>
                                        </block>
                                    </value>
                                </block>
                            </next>
                        </block>
                    </statement>
                </block>
            </next>
        </block>
    </xml>
    <br>
    <!-- <textarea id="mycode" rows="12" style="width: 100%;"></textarea> -->
    <script>
        var workspace = Blockly.inject('blocklyDiv', { toolbox: document.getElementById('toolbox') });
        var defaultBlocks = document.getElementById('blocklyDefault');
        Blockly.Xml.domToWorkspace(defaultBlocks, workspace);

        function myUpdateFunction(event) {
            var languageDropdown = document.getElementById('languageDropdown');
            var languageSelection = languageDropdown.options[languageDropdown.selectedIndex].value;
            var codeDiv = document.getElementById('codeDiv');
            var codeHolder = document.createElement('pre');
            codeHolder.className = 'prettyprint but-not-that-pretty';
            // var code = document.createTextNode(Blockly[languageSelection].workspaceToCode(workspace));
            // codeHolder.appendChild(code);
            var code;
            if (languageSelection === 'Dart') {
                var jsCode = Blockly.JavaScript.workspaceToCode(workspace);
                try {
                    code = ts2c.transpile(jsCode); // 调用转换方法
                } catch (error) {
                    code = '转换失败: ' + error.message;
                }
            } else {
                code = Blockly[languageSelection].workspaceToCode(workspace);
            }
            var textCode = document.createTextNode(code);
            codeHolder.appendChild(textCode);
            codeDiv.replaceChild(codeHolder, codeDiv.lastElementChild);
            prettyPrint();

            // 保存代码到 localStorage
            localStorage.setItem('blocklyCode', code);

            // 发送代码到父窗口
            // window.parent.postMessage({
            //     type: 'BLOCKLY_CODE_UPDATE',
            //     language: languageSelection,
            //     code: generatedCode
            // }, '*');
        }
        workspace.addChangeListener(myUpdateFunction);
        function executeBlockCode() {
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            var initFunc = function (interpreter, scope) {
                var alertWrapper = function (text) {
                    text = text ? text.toString() : '';
                    return interpreter.createPrimitive(alert(text));
                };
                interpreter.setProperty(scope, 'alert',
                    interpreter.createNativeFunction(alertWrapper));
                var promptWrapper = function (text) {
                    text = text ? text.toString() : '';
                    return interpreter.createPrimitive(prompt(text));
                };
                interpreter.setProperty(scope, 'prompt',
                    interpreter.createNativeFunction(promptWrapper));
            };
            var myInterpreter = new Interpreter(code, initFunc);
            var stepsAllowed = 10000;
            while (myInterpreter.step() && stepsAllowed) {
                stepsAllowed--;
            }
            if (!stepsAllowed) {
                throw EvalError('Infinite loop.');
            }
        }

        document.getElementById('playButton').addEventListener('click', executeBlockCode);

        // 绑定清空工作区按钮的点击事件
        document.getElementById('trashButton').addEventListener('click', function () {
            workspace.clear();// 清空工作区
            myUpdateFunction();// 重新渲染代码展示区域
        });

        document.addEventListener('DOMContentLoaded', function () {
            // 获取按钮元素
            const runButton = document.getElementById('runButton');
            const stopButton = document.getElementById('stopButton');
            const saveButton = document.getElementById('saveButton');


            // 绑定点击事件
            if (runButton) {
                runButton.addEventListener('click', Code.runJS);
            }
            if (stopButton) {
                stopButton.addEventListener('click', Code.stopJS);
            }
            if (saveButton) {
                saveButton.addEventListener('click', function () {
                    var languageDropdown = document.getElementById('languageDropdown');
                    var languageSelection = languageDropdown.options[languageDropdown.selectedIndex].value;
                    var code;
                    if (languageSelection === 'Dart') {
                        var jsCode = Blockly.JavaScript.workspaceToCode(workspace);
                        try {
                            code = ts2c.transpile(jsCode); // 调用转换方法
                        } catch (error) {
                            code = '转换失败: ' + error.message;
                        }
                    } else {
                        code = Blockly[languageSelection].workspaceToCode(workspace);
                    }
                    var blob = new Blob([code], { type: 'text/plain;charset=utf-8' });
                    saveAs(blob, 'translated_code.c');
                });
            }
        });
    </script>
</body>

</html>