
<view class="container"
style="background-image: url({{chatBackground}}); background-size: cover;">
  <!-- 页面顶部加载提示 -->
<view class="input-indicator" wx:if="{{showInputIndicator}}">
  <text class="indicator-text">对方正在输入中...</text>
</view>
  <!-- 聊天内容区域 -->
  <scroll-view 
  class="message-list" 
  scroll-y 
  scroll-top="{{scrollTop}}"
  style="height: calc(100vh - {{inputHeight}}px); margin-bottom: {{inputHeight}}px;"
>
    <block wx:for="{{messages}}" wx:key="index">
      <!-- 对方消息（左对齐） -->
      <view class="message-left" wx:if="{{item.messageRole=='Assistant'}}">
        <image class="avatar" src="{{conversationShow.conUrl}}"/>
        <view class="message-content"
        bindlongpress="handleLongPress" 
        data-message="{{item}}"
        data-index="{{index}}">
          <text class="username" wx:if="{{conversationShow.conversation.conAiNotes!=null}}">{{conversationShow.conversation.conAiNotes}}</text>
          <text wx:else>{{conversationShow.conversation.conAiName}}</text>
          <view class="bubble">
            <block wx:if="{{item.messageTypeFlag === 1}}">
              <view class="voice-message">
                <!-- 语音识别文字 -->
                <text wx:if="{{item.messageRecognition===1}}" class="recognized-text">
                  {{item.messageRecText}}
                </text>
                <view class="voice-control">
                  <image 
                    class="voice-icon"
                    bindtap="playAudio"
                    data-index="{{index}}"
                    src="{{item.messagePlaying ? '/images/play.png' : '/images/pause.png'}}"
                  />
                  <!-- <text class="duration">{{item.messageDuration}}"</text> -->
                </view>
              </view>
            </block>
            <block wx:else>{{item.messageContent}}</block>
          </view>
          <text class="time">{{item.messageTime}}</text>
        </view>
      </view>

      <!-- 己方消息（右对齐） -->
      <view class="message-right" wx:else>
        <image class="avatar" src="{{user.pictureUrl}}"/>
        <view class="message-content"
        bindlongpress="handleLongPress" 
        data-message="{{item}}"
        data-index="{{index}}">
          <text class="username">{{user.userInfo.userName}}</text>
          <view class="bubble">
            <block wx:if="{{item.messageTypeFlag === 1}}">
              <view class="voice-message">
                <!-- 语音识别文字 -->
                <text wx:if="{{item.messageRecognition===1}}" class="recognized-text">
                  {{item.messageRecText}}
                </text>
                <view class="voice-control">
                  <image 
                  class="voice-icon"
                  bindtap="playAudio"
                  data-index="{{index}}"
                  src="{{item.messagePlaying ? '/images/play.png' : '/images/pause.png'}}" />
                  <text class="duration">{{item.messageDuration/1000}}"</text>
                </view>
              </view>
            </block>
            <block wx:else>{{item.messageContent}}</block>
          </view>
          <text class="time">{{item.messageTime}}</text>
        </view>
      </view>
    </block>
  </scroll-view>

  <!-- 底部输入栏 -->
  <view class="input-area">
    <view class="input-container">
      <!-- 输入模式切换 -->
      <image 
        class="mode-switch"
        src="{{isVoiceMode ? '/images/keyboard.png' : '/images/voice.png'}}"
        bindtap="toggleInputMode"
      />

      <!-- 文字输入模式 -->
      <input 
        class="text-input"
        placeholder="输入消息"
        wx:if="{{!isVoiceMode}}"
        value="{{inputText}}"
        bindinput="onInput"
        bindconfirm="sendText"
      />

      <!-- 语音输入模式 -->
      <button 
        class="voice-btn"
        wx:if="{{isVoiceMode}}"
        bindtouchstart="startRecord"
        bindtouchend="stopRecord"
        bindtouchmove="handleTouchMove"
        disabled="{{isRecording}}"
      >
        按住说话
      </button>
      <!--设置-->
      <block wx:if="{{!isVoiceMode && inputText.length == 0}}">
        <view bind:tap="goSetting">
        <image class="con-set"
        src="/images/add_set.png"></image>
        </view>
      </block>
      <!-- 发送按钮 -->
      <button 
        class="send-btn"
        wx:if="{{!isVoiceMode && inputText.length > 0}}"
        bindtap="sendText"
      >
        发送
      </button>
    </view>

    <!-- 录音状态提示 -->
    <view 
      class="record-indicator {{isSwiping ? 'cancel' : ''}}"
      wx:if="{{isRecording}}"
    >
      <!-- <view class="waveform">
        <block wx:for="{{waveformData}}" wx:key="index">
          <view class="wave-bar" style="height: {{item}}"></view>
        </block>
      </view> -->
      {{isSwiping ? '松开取消' : '正在录音'}}
    </view>
  </view>
</view>